<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Kutty ma ğŸ’–</title>

  <style>
    :root{
      --bg1:#ff2d95; --bg2:#5b7bff; --bg3:#00e6b8; --bg4:#ffd166;
      --card: rgba(255,255,255,.92);
      --accent:#d81b60;
      --shadow: 0 18px 60px rgba(0,0,0,.18);
      --glow: 0 0 25px rgba(255,105,180,.55);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; height:100vh; overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#222;
    }

    /* Background */
    .bg{
      position:fixed; inset:0;
      background: linear-gradient(120deg, var(--bg1), var(--bg2), var(--bg3), var(--bg4), var(--bg1));
      background-size: 500% 500%;
      animation: gradient 10s ease infinite;
    }
    @keyframes gradient{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* Sparkles */
    .sparkles{
      position:fixed; inset:0; pointer-events:none;
      background-image:
        radial-gradient(rgba(255,255,255,.55) 1px, transparent 2px),
        radial-gradient(rgba(255,255,255,.30) 1px, transparent 2px),
        radial-gradient(rgba(255,255,255,.20) 1px, transparent 2px);
      background-size: 160px 160px, 120px 120px, 80px 80px;
      background-position: 0 0, 40px 60px, 20px 30px;
      mix-blend-mode: overlay;
      opacity:.48;
      animation: twinkle 7s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{opacity:.34; transform:scale(1)}
      50%{opacity:.62; transform:scale(1.02)}
    }

    /* Emoji rain */
    .floaters{ position:fixed; inset:0; pointer-events:none; overflow:hidden; }
    .floater{
      position:absolute;
      font-size: clamp(18px, 3.5vw, 38px);
      opacity:.95;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.18));
      animation: floatUp linear forwards;
      will-change: transform, opacity;
    }
    @keyframes floatUp{
      0%   { transform: translateY(110vh) rotate(0deg); opacity:0; }
      12%  { opacity:1; }
      100% { transform: translateY(-25vh) rotate(520deg); opacity:0; }
    }

    canvas#fx{ position:fixed; inset:0; pointer-events:none; }

    .wrap{ position:relative; height:100vh; display:grid; place-items:center; padding:16px; }
    .card{
      width:min(840px, 95vw);
      background: var(--card);
      border-radius:22px;
      padding: 22px 18px 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.45);
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute; top:14px; right:14px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(255,105,180,.25);
      border-radius:999px;
      padding:8px 12px;
      font-weight:950;
      font-size:12px;
      color:#b91c1c;
      box-shadow: var(--glow);
    }
    h1{
      margin: 6px 0 6px;
      font-size: clamp(24px, 4vw, 42px);
      color: var(--accent);
      text-align:center;
      text-shadow: 0 10px 30px rgba(216,27,96,.18);
    }
    .subtitle{
      margin:0 0 12px;
      text-align:center;
      opacity:.85;
      font-weight:850;
    }

    .scene{ display:none; animation: pop .35s ease; }
    .scene.active{ display:block; }
    @keyframes pop{
      from{ transform: translateY(10px) scale(.985); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    /* Quiz UI */
    .toprow{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin: 8px 4px 12px;
    }
    .pill{
      background: rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.08);
      padding:8px 12px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      box-shadow: 0 10px 25px rgba(0,0,0,.07);
    }
    .score{ color:#6a1b9a; }

    .qbox{
      border-radius:18px; padding:16px;
      background: linear-gradient(135deg, rgba(255,192,203,.38), rgba(173,216,230,.28));
      border: 1px dashed rgba(216,27,96,.25);
    }
    .question{ font-weight:980; font-size:18px; text-align:center; margin:4px 0 12px; color:#111; }
    .options{ display:grid; gap:10px; width:min(620px,100%); margin:0 auto; }
    .opt{
      border:none; cursor:pointer;
      padding: 14px;
      border-radius:16px;
      font-weight:980; font-size:15px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
      transition: transform .12s ease, filter .2s ease;
      text-align:center;
    }
    .opt:hover{ filter: brightness(1.03); }
    .opt:active{ transform: scale(.98); }
    .opt.selected{
      outline: 3px solid rgba(216,27,96,.25);
      box-shadow: 0 0 0 6px rgba(216,27,96,.08), 0 14px 28px rgba(0,0,0,.12);
      transform: translateY(-1px);
    }

    .feedback{
      margin-top:12px;
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 25px rgba(0,0,0,.07);
      min-height:54px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      font-weight:900;
      color:#333;
    }
    .feedback.good{ border-color: rgba(34,197,94,.35); color:#14532d; }
    .feedback.warn{ border-color: rgba(245,158,11,.35); color:#7c2d12; }
    .feedback.bad{ border-color: rgba(239,68,68,.35); color:#7f1d1d; }

    .actions{ display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .action{
      border:none; cursor:pointer;
      padding:12px 18px;
      border-radius:999px;
      font-weight:980;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 25px rgba(0,0,0,.10);
    }
    .action.primary{
      background: linear-gradient(135deg, #ff2d95, #ff8fab, #ffd166);
      color:white;
      border:none;
      box-shadow: var(--glow);
    }
    .action:disabled{ opacity:.55; cursor:not-allowed; }

    /* Proposal card */
    .proposal{
      width:min(680px, 100%);
      margin: 0 auto;
      border-radius: 22px;
      padding: 18px 16px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .proposal:before{
      content:"";
      position:absolute; inset:-60px;
      background: radial-gradient(circle at 20% 30%, rgba(255,45,149,.18), transparent 55%),
                  radial-gradient(circle at 80% 70%, rgba(0,230,184,.16), transparent 55%),
                  radial-gradient(circle at 60% 10%, rgba(255,209,102,.14), transparent 55%);
      transform: rotate(10deg);
    }
    .proposal > *{ position:relative; }
    .ring{ font-size:44px; filter: drop-shadow(0 10px 18px rgba(0,0,0,.18)); }
    .proposal h2{ margin:10px 0 6px; color:#c2185b; font-weight:1000; }
    .proposal .line{ font-weight:900; color:#333; }
    .proposal .place{ margin-top:10px; font-weight:1000; color:#6a1b9a; }
    .tiny{ margin-top:10px; font-size:12px; opacity:.85; font-weight:800; }

    /* Love scene */
    .arena{
      position:relative;
      width: min(680px, 100%);
      height: 240px;
      margin: 10px auto 0;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255,192,203,.38), rgba(173,216,230,.28));
      border: 1px dashed rgba(216,27,96,.25);
      overflow:hidden;
    }
    .btn{
      border:none; cursor:pointer;
      padding:14px 26px;
      font-weight:990;
      border-radius:999px;
      font-size:16px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      position:absolute;
      top:26px;
      white-space:nowrap;
      transition: transform .12s ease, filter .2s ease;
    }
    .btn:active{ transform: scale(.98); }
    #yesBtn{ background:#22c55e; color:white; left:50%; transform: translateX(-125%); }
    #noBtn{ background:#ff3b5c; color:white; left:50%; transform: translateX(20%); touch-action:none; }

    .finalText{
      margin-top: 10px;
      text-align:center;
      font-weight: 980;
      font-size: 18px;
      color:#6a1b9a;
      min-height: 28px;
    }
    .hint{ margin-top:10px; text-align:center; font-size:12px; opacity:.78; font-weight:800; }

    /* End Popup */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.42);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
      backdrop-filter: blur(8px);
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:min(700px, 92vw);
      background: rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.45);
      border-radius:22px;
      padding:18px 16px;
      box-shadow: 0 24px 90px rgba(0,0,0,.28);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-60px;
      background: radial-gradient(circle at 25% 35%, rgba(255,45,149,.20), transparent 55%),
                  radial-gradient(circle at 80% 65%, rgba(0,230,184,.18), transparent 55%),
                  radial-gradient(circle at 60% 15%, rgba(255,209,102,.16), transparent 55%);
      transform: rotate(10deg);
    }
    .modal > *{ position:relative; }
    .modal h2{ margin:6px 0 8px; color:#c2185b; font-size:24px; font-weight:1000; }
    .modal p{ margin:8px 0 0; font-weight:900; color:#333; line-height:1.55; white-space: pre-wrap; }
    .modalActions{ margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .small{ margin-top:10px; font-size:12px; opacity:.85; font-weight:800; }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="sparkles"></div>
  <div class="floaters" id="floaters"></div>
  <canvas id="fx"></canvas>

  <!-- End Romantic Popup -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div style="font-size:38px;">ğŸ’–ğŸŒ¸ğŸ†</div>
      <h2 id="modalTitle">Kutty maaaa ğŸ˜­ğŸ’–</h2>
      <p id="modalBody">Loadingâ€¦</p>
      <div class="modalActions">
        <button class="action primary" id="copyBtn">Copy message âœ…</button>
        <button class="action" id="closeModalBtn">Close ğŸ’</button>
      </div>
      <div class="small">Tip: Screenshot this popup & send me ğŸ˜Œ</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="badge">ğŸŒ¸ For Kutty ma ğŸ’–</div>

      <h1 id="mainTitle">Kutty ma Quiz ğŸ˜ğŸ’–</h1>
      <p class="subtitle" id="mainSub">Answer 3 questionsâ€¦ then proposalâ€¦ then final love question ğŸ˜ˆğŸ’˜</p>

      <!-- Scene 1: Quiz -->
      <div class="scene active" id="quizScene">
        <div class="toprow">
          <div class="pill" id="progressPill">Question 1 / 3</div>
          <div class="pill score" id="scorePill">Score: 0</div>
        </div>

        <div class="qbox">
          <div class="question" id="qText">Loadingâ€¦</div>
          <div class="options" id="options"></div>

          <div class="feedback" id="feedback">Pick one option ğŸ˜ (you can change later)</div>

          <div class="actions">
            <button class="action" id="backBtn" disabled>Back</button>
            <button class="action primary" id="nextBtn" disabled>Next âœ¨</button>
          </div>
        </div>

        <div class="hint">You can reselect options any time â€” score updates live âœ…</div>
      </div>

      <!-- Scene 2: Proposal -->
      <div class="scene" id="proposalScene">
        <div class="proposal">
          <div class="ring">ğŸ’</div>
          <h2>Kutty maâ€¦ will you be my Valentine? ğŸŒ¹</h2>
          <div class="line">More dates, more laughs, more â€œusâ€ ğŸ’</div>
          <div class="place">Proposal: Snacks at Aladipattiyan ğŸ˜‹ğŸŒ¸</div>
          <div class="tiny">Now one final questionâ€¦ donâ€™t be shy ğŸ˜</div>

          <div class="actions" style="margin-top:14px;">
            <button class="action" id="openMaps2">Open Maps ğŸ—ºï¸</button>
            <button class="action primary" id="goFinal">Go to final question ğŸ’–</button>
          </div>
        </div>

        <div class="hint">This is your official Valentine proposal ğŸ˜­ğŸ’˜</div>
      </div>

      <!-- Scene 3: Love Finale -->
      <div class="scene" id="loveScene">
        <h1 style="margin-top:0;">Kutty ma, do you love me? ğŸ’–</h1>
        <p class="subtitle">Choose wisely ğŸ˜ (No button is alive)</p>

        <div class="arena" id="arena">
          <button class="btn" id="yesBtn">Yes ğŸ˜</button>
          <button class="btn" id="noBtn">No ğŸ™ƒ</button>
        </div>

        <div class="finalText" id="finalText"></div>

        <div class="actions">
          <button class="action" id="openMaps">Open Maps ğŸ—ºï¸</button>
          <button class="action primary" id="closeBtn">Close ğŸ’</button>
        </div>

        <div class="hint">After you clickâ€¦ youâ€™ll get the romantic popup ğŸ˜ŒğŸ’˜</div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ========= DOM =========
      const $ = (id)=>document.getElementById(id);

      // Scenes
      const quizScene = $("quizScene");
      const proposalScene = $("proposalScene");
      const loveScene = $("loveScene");

      const mainTitle = $("mainTitle");
      const mainSub = $("mainSub");

      // Quiz UI
      const qText = $("qText");
      const optionsEl = $("options");
      const feedbackEl = $("feedback");
      const progressPill = $("progressPill");
      const scorePill = $("scorePill");
      const backBtn = $("backBtn");
      const nextBtn = $("nextBtn");

      // Love UI
      const arena = $("arena");
      const yesBtn = $("yesBtn");
      const noBtn  = $("noBtn");
      const finalText = $("finalText");

      // Modal
      const modalOverlay = $("modalOverlay");
      const modalTitle = $("modalTitle");
      const modalBody  = $("modalBody");
      const copyBtn = $("copyBtn");
      const closeModalBtn = $("closeModalBtn");
      let lastCopied = "";

      // Floaters
      const floaters = $("floaters");
      const EMOJIS = ["ğŸ’–","ğŸ’˜","ğŸ’","â¤ï¸","ğŸŒ¹","ğŸŒ¸","ğŸŒ·","âœ¨","ğŸ«¶","ğŸ¥°","ğŸ«","ğŸ€","ğŸ’","ğŸª·","ğŸ¦‹","ğŸŒº","ğŸ†"];
      const rand = (min, max)=>Math.floor(Math.random()*(max-min+1))+min;

      function spawnFloaters(count){
        for(let i=0;i<count;i++){
          const el = document.createElement("div");
          el.className="floater";
          el.textContent = EMOJIS[rand(0, EMOJIS.length-1)];
          el.style.left = rand(0,100) + "vw";
          const dur = rand(4200, 9800);
          const delay = rand(0, 520);
          el.style.animationDuration = dur + "ms";
          el.style.animationDelay = delay + "ms";
          el.style.opacity = (Math.random()*0.35 + 0.55).toFixed(2);
          floaters.appendChild(el);
          setTimeout(()=>el.remove(), dur+delay+250);
        }
      }

      // ========= Canvas FX =========
      const fx = $("fx");
      const ctx = fx.getContext("2d");
      let particles = [];

      function resizeFX(){
        fx.width = window.innerWidth * devicePixelRatio;
        fx.height = window.innerHeight * devicePixelRatio;
        ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      }

      function confettiBurst(n=320){
        const colors = ["#ff2d95","#ff8fab","#ffd166","#06d6a0","#4cc9f0","#a78bfa","#fb7185","#f472b6","#22c55e","#f97316","#ffffff"];
        for(let i=0;i<n;i++){
          particles.push({
            x: window.innerWidth/2 + rand(-140,140),
            y: window.innerHeight/2 + rand(-90,90),
            vx: (Math.random()*11-5.5),
            vy: (Math.random()*-15-4),
            g: 0.20 + Math.random()*0.16,
            r: 2 + Math.random()*6,
            a: 1,
            rot: Math.random()*Math.PI,
            vr: (Math.random()*0.40-0.20),
            c: colors[rand(0, colors.length-1)],
            life: 240 + rand(0,140),
            type: "confetti"
          });
        }
      }

      function fireworks(bursts=5){
        const colors = ["#ffffff","#ffe066","#ff5d8f","#4cc9f0","#c77dff","#06d6a0","#ffd166","#ff2d95","#22c55e"];
        for(let b=0;b<bursts;b++){
          const cx = rand(12, 88) * window.innerWidth/100;
          const cy = rand(10, 55) * window.innerHeight/100;
          const count = 170 + rand(0,110);
          for(let i=0;i<count;i++){
            const ang = Math.random()*Math.PI*2;
            const sp = 2.2 + Math.random()*6.8;
            particles.push({
              x: cx, y: cy,
              vx: Math.cos(ang)*sp,
              vy: Math.sin(ang)*sp,
              g: 0.04 + Math.random()*0.07,
              r: 1.2 + Math.random()*2.8,
              a: 1,
              rot: 0, vr: 0,
              c: colors[rand(0, colors.length-1)],
              life: 165 + rand(0,115),
              type: "spark"
            });
          }
        }
      }

      function flowerPops(pops=4){
        const flowerColors = ["#ff2d95","#ff8fab","#ffd166","#22c55e","#4cc9f0","#c77dff","#ffffff"];
        for(let p=0;p<pops;p++){
          const cx = rand(20, 80) * window.innerWidth/100;
          const cy = rand(18, 65) * window.innerHeight/100;
          const count = 110 + rand(0,60);
          for(let i=0;i<count;i++){
            const ang = Math.random()*Math.PI*2;
            const sp = 1.8 + Math.random()*5.2;
            particles.push({
              x: cx, y: cy,
              vx: Math.cos(ang)*sp,
              vy: Math.sin(ang)*sp,
              g: 0.05 + Math.random()*0.06,
              r: 1.8 + Math.random()*3.2,
              a: 1,
              rot: 0, vr: 0,
              c: flowerColors[rand(0, flowerColors.length-1)],
              life: 150 + rand(0,90),
              type: "spark"
            });
          }
        }
      }

      function tickFX(){
        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
        particles = particles.filter(p => p.life-- > 0 && p.a > 0.02);

        for(const p of particles){
          p.x += p.vx; p.y += p.vy; p.vy += p.g; p.rot += p.vr; p.a *= 0.991;

          ctx.save();
          ctx.globalAlpha = p.a;
          ctx.fillStyle = p.c;

          if(p.type === "confetti"){
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillRect(-p.r, -p.r/2, p.r*2.8, p.r);
          }else{
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fill();
          }
          ctx.restore();
        }
        requestAnimationFrame(tickFX);
      }

      // ========= Modal =========
      function showEndPopup(title, body){
        modalTitle.textContent = title;
        modalBody.textContent = body;
        lastCopied = body;
        modalOverlay.classList.add("show");

        // massive celebration
        spawnFloaters(90);
        confettiBurst(900);
        fireworks(10);
        flowerPops(7);
      }
      copyBtn.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(lastCopied);
          copyBtn.textContent = "Copied âœ…";
          setTimeout(()=>copyBtn.textContent="Copy message âœ…", 1400);
        }catch(e){
          copyBtn.textContent = "Copy blocked ğŸ˜…";
          setTimeout(()=>copyBtn.textContent="Copy message âœ…", 1600);
        }
      });
      closeModalBtn.addEventListener("click", ()=> modalOverlay.classList.remove("show"));
      modalOverlay.addEventListener("click", (e)=> { if(e.target===modalOverlay) modalOverlay.classList.remove("show"); });

      // ========= Scene switch =========
      function showScene(scene){
        [quizScene, proposalScene, loveScene].forEach(s => s.classList.remove("active"));
        scene.classList.add("active");
      }

      // ========= Quiz Data (reselect enabled) =========
      const QUESTIONS = [
        {
          q: "When I pinged you first time? ğŸ˜Œ",
          options: [
            { label: "Feb 15 â€” 5:30 o'clock", grade:"good", correct:true,
              msg:"Ayyy Kutty ma ğŸ¥ºğŸ’– perfect memory! That moment is special for me." },
            { label: "Feb 15 â€” 5:15 o'clock", grade:"bad", correct:false,
              msg:"Ayo ğŸ˜¤ wrong! You forgot my first ping ah? Hmm suspicious ğŸ˜" },
            { label: "Feb 15 â€” 6:00 o'clock", grade:"bad", correct:false,
              msg:"Eiii ğŸ˜¤ not this time! Think properly Kutty ma ğŸ˜Œ" }
          ]
        },
        {
          q: "Whatâ€™s my fav food? ğŸ˜‹",
          options: [
            { label: "Dosa ğŸ¥ğŸ’–", grade:"good", correct:true,
              msg:"Awww YESSS ğŸ˜­ğŸ’– Dosa is love! You know me too well, Kutty ma ğŸ«¶" },
            { label: "Briyani ğŸ—ğŸ™‚", grade:"warn", correct:false,
              msg:"Briyani is nice ğŸ˜Œ but not my #1â€¦ still cute attempt ğŸ˜‚" },
            { label: "Rasam ğŸ²ğŸ˜…", grade:"warn", correct:false,
              msg:"Rasam ok ok ğŸ˜… but not my topâ€¦ still love you ğŸ˜" }
          ]
        },
        {
          q: "Where we went for your bday? ğŸ‚",
          options: [
            { label: "Temple + Beach ğŸŒ¸ğŸ–ï¸", grade:"good", correct:true,
              msg:"Kutty maaaa ğŸ˜­ğŸ’– correct! That day was peaceful and perfect with you." },
            { label: "Beach + Temple ğŸ–ï¸ğŸŒ¸", grade:"bad", correct:false,
              msg:"Close ğŸ˜¤ but wrong order! Think properly ğŸ˜‚" },
            { label: "Temple + Sunset Beach ğŸŒ¸ğŸŒ…", grade:"bad", correct:false,
              msg:"Nice idea ğŸ˜¤ but not our actual plan! Youâ€™re testing me ah? ğŸ˜" }
          ]
        }
      ];

      let qIndex = 0;
      const answers = new Array(QUESTIONS.length).fill(null);

      function computeScore(){
        return answers.reduce((s, optIndex, qi) => {
          if(optIndex === null) return s;
          return s + (QUESTIONS[qi].options[optIndex].correct ? 1 : 0);
        }, 0);
      }

      function setFeedback(grade, text){
        feedbackEl.className = "feedback " + grade;
        feedbackEl.textContent = text;
      }

      function renderQuestion(){
        const Q = QUESTIONS[qIndex];

        progressPill.textContent = `Question ${qIndex+1} / ${QUESTIONS.length}`;
        scorePill.textContent = `Score: ${computeScore()}`;
        qText.textContent = Q.q;

        optionsEl.innerHTML = "";
        backBtn.disabled = (qIndex === 0);
        nextBtn.disabled = (answers[qIndex] === null);

        if(answers[qIndex] === null){
          feedbackEl.className = "feedback";
          feedbackEl.textContent = "Pick one option ğŸ˜ (you can change later)";
        } else {
          const picked = Q.options[answers[qIndex]];
          setFeedback(picked.grade, picked.msg);
        }

        Q.options.forEach((opt, i) => {
          const btn = document.createElement("button");
          btn.className = "opt";
          btn.textContent = opt.label;
          if(answers[qIndex] === i) btn.classList.add("selected");

          btn.addEventListener("click", () => {
            answers[qIndex] = i;
            [...optionsEl.querySelectorAll(".opt")].forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");

            setFeedback(opt.grade, opt.msg);
            scorePill.textContent = `Score: ${computeScore()}`;
            nextBtn.disabled = false;

            // effects by grade
            if(opt.grade === "good"){
              spawnFloaters(20); confettiBurst(360); fireworks(5); flowerPops(3);
            } else if(opt.grade === "warn"){
              spawnFloaters(12); confettiBurst(220); fireworks(2);
            } else {
              spawnFloaters(8); confettiBurst(140);
            }
          });

          optionsEl.appendChild(btn);
        });
      }

      backBtn.addEventListener("click", () => {
        if(qIndex > 0){ qIndex--; renderQuestion(); }
      });

      nextBtn.addEventListener("click", () => {
        if(qIndex < QUESTIONS.length - 1){
          qIndex++; renderQuestion();
        } else {
          // go to proposal scene
          mainTitle.textContent = "Proposal Time ğŸ˜­ğŸ’–";
          mainSub.textContent = "Now read this carefullyâ€¦";
          showScene(proposalScene);
          spawnFloaters(35); confettiBurst(500); fireworks(6); flowerPops(4);
        }
      });

      // ========= Proposal buttons =========
      function openMaps(){
        const q = encodeURIComponent("Aladipattiyan");
        window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
      }
      $("openMaps2").addEventListener("click", openMaps);
      $("goFinal").addEventListener("click", () => {
        mainTitle.textContent = "Valentine Finale ğŸ’˜";
        mainSub.textContent = "Now answer honestlyâ€¦ my Kutty ma ğŸ˜ŒğŸŒ¹";
        showScene(loveScene);
        spawnFloaters(30); confettiBurst(420); fireworks(5); flowerPops(3);
        setTimeout(moveNoButton, 350);
      });

      // ========= Love logic =========
      const noTexts = [
        "No ğŸ™ƒ","Nope ğŸ˜ˆ","Are you sure? ğŸ˜","Think again ğŸ¤­","Not allowed ğŸš«ğŸ˜„",
        "Try again ğŸ˜‚","Wrong button ğŸ˜­","NO disabled ğŸ”’","No is on leave ğŸƒâ€â™‚ï¸",
        "404 No not found ğŸ˜…","Nice try ğŸ˜Œ","Stop chasing me ğŸ˜­","Pick YES ğŸ˜",
        "Maintenance ğŸ› ï¸","No is shy ğŸ™ˆ","No ran away ğŸƒâ€â™€ï¸","No? really? ğŸ‘€",
        "Illegal ğŸ˜ˆ","Not today ğŸ˜Œ","Finger slipped ğŸ˜…","Recheckingâ€¦ ğŸ’–",
        "Heart says YES ğŸ’˜","Allergic to NO ğŸ¤§","NO deleted âœ…",
        "Destiny ğŸ’","Come onnn ğŸ˜","Canâ€™t click ğŸ˜†","Only YES works ğŸ’š",
        "Okayâ€¦ you love me ğŸ˜ŒğŸ’–","Final: YES only ğŸ˜­ğŸ’˜","Nice try, thangoo ğŸ˜"
      ];

      const rosesAfterDecision =
`Roses are red ğŸŒ¹
Violets are blue ğŸ’œ
Kutty maâ€¦ my heart is calm
Only when itâ€™s with you ğŸ«¶`;

      let noAttempts = 0;
      let locked = false;

      function moveNoButton(){
        const r = arena.getBoundingClientRect();
        const w = noBtn.offsetWidth;
        const h = noBtn.offsetHeight;
        const pad = 10;
        const maxX = Math.max(pad, Math.floor(r.width  - w - pad));
        const maxY = Math.max(pad, Math.floor(r.height - h - pad));
        noBtn.style.left = rand(pad, maxX) + "px";
        noBtn.style.top  = rand(pad, maxY) + "px";
        noBtn.style.transform = "none";
      }

      function finalWin(fromNo){
        if(locked) return;
        locked = true;

        finalText.textContent = fromNo ? "I know you love me ğŸ˜ŒğŸ’–" : "Yayyy ğŸ˜­ğŸ’– I love you too, Kutty ma!";

        // mega
        spawnFloaters(120); confettiBurst(1200); fireworks(12); flowerPops(9);

        yesBtn.disabled = true;
        noBtn.disabled = true;
        yesBtn.style.opacity = "0.75";
        noBtn.style.opacity = "0.55";
        yesBtn.style.cursor = "not-allowed";
        noBtn.style.cursor = "not-allowed";

        const score = computeScore();
        const body =
`${fromNo ? "Even if you tried NOâ€¦ ğŸ˜" : "You clicked YES ğŸ˜­âœ¨"}

${rosesAfterDecision}

Quiz Score: ${score}/3

Proposal: Snacks at Aladipattiyan ğŸ˜‹ğŸŒ¸
Now tell meâ€¦ when are we going? ğŸ«¶

I luuuvvv uu thangoo ğŸ˜­ğŸ’–`;

        setTimeout(()=>showEndPopup("Kutty maaaa ğŸ˜­ğŸ’–", body), 600);
      }

      function onNoAttempt(){
        if(locked) return;
        noAttempts++;
        noBtn.textContent = noTexts[(noAttempts-1) % noTexts.length];

        const grow = Math.min(1.35, 1 + noAttempts * 0.03);
        yesBtn.style.transform = `translateX(-125%) scale(${grow})`;

        moveNoButton();
        spawnFloaters(6);
        confettiBurst(120);

        if(noAttempts >= 10) setTimeout(()=>finalWin(true), 250);
      }

      ["mouseenter","mouseover","pointerenter"].forEach(evt => noBtn.addEventListener(evt, onNoAttempt));
      noBtn.addEventListener("touchstart", (e)=>{ e.preventDefault(); onNoAttempt(); }, { passive:false });
      noBtn.addEventListener("click", (e)=>{ e.preventDefault(); finalWin(true); });
      yesBtn.addEventListener("click", ()=> finalWin(false));

      // maps + close
      $("openMaps").addEventListener("click", openMaps);
      $("closeBtn").addEventListener("click", () => {
        finalText.textContent = "Okay Kutty ma ğŸ˜ŒğŸ’– close this tabâ€¦ and send me screenshot ğŸ˜ˆ";
        spawnFloaters(35); confettiBurst(420); fireworks(4); flowerPops(2);
        try { window.close(); } catch(e) {}
      });

      // ========= Start =========
      let started = false;
      function start(){
        if(started) return;
        started = true;

        resizeFX();
        requestAnimationFrame(tickFX);

        // constant emoji rain
        setInterval(() => spawnFloaters(2), 650);

        renderQuestion();
        spawnFloaters(18);
      }

      document.addEventListener("DOMContentLoaded", start, { once:true });
      if(document.readyState === "interactive" || document.readyState === "complete") start();

      window.addEventListener("resize", resizeFX);

    })();
  </script>
</body>
</html>
